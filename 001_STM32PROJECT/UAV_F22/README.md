# UAVF22 无人机控制系统

基于STM32F103RCT6微控制器的四旋翼无人机（UAVF22）悬停控制系统项目。本项目实现了完整的无人机姿态控制功能，采用MPU6050传感器和DMP姿态解算，配合串级PID控制算法实现稳定悬停。

## 项目概述

本项目包含两个版本，分别实现不同的飞行功能：

### V2.5 版本 - 单纯悬停控制

**主要功能**：
- 实现基础的无人机悬停功能
- 采用增量式PID控制器提高控制精度
- 1ms定时中断（1KHz）保证控制实时性
- 串级PID控制架构（角度环200Hz + 角速度环1000Hz）
- 4秒安全保护机制，防止失控飞走

**技术特点**：
- 角速度数据采集优化：移至定时器中断内执行
- PID算法升级：从普通PID改为增量式PID，响应更快
- PID输出限幅参数统一管理
- 完善的安全机制代码

**使用说明**：
- 需要先调整好旋翼和电机转动方向
- 确保旋翼弯曲方向与视频一致
- 电机转动方向一致，M1M2M3M4焊接顺序相同
- 必须系好安全绳，防止飞到屋顶坠机
- 未使用气压计，注意飞行高度控制

### V2.9.4.10.24 版本 - 跳跃功能控制

**主要功能**：
- 基于V2.5版本的改进升级
- 实现两次跳跃动作的飞行逻辑
- 增加按键控制第二次起飞功能
- 预留视觉传感器接口区
- 支持飞行路径规划

**技术特点**：
- 增加飞行逻辑控制段
- 实现F1_Time、STOP、Up2_Time等多阶段控制
- 支持横滚、俯仰、偏航的三轴独立控制
- 增加PID死区控制，提高稳定性
- 优化电机控制逻辑

**使用说明**：
- 先使用V2.5版本调整好电机和旋翼
- 按键控制第二次起飞启动
- 实现两次跳跃动作：第一次起飞 -> 停止 -> 第二次起飞
- 预留视觉传感器接口，可扩展自主导航功能

## 核心技术架构

### 硬件平台
- **微控制器**: STM32F103RCT6 (LQFP64封装)
- **姿态传感器**: MPU6050 + DMP（需原装芯片）
- **通信接口**: I2C2（PB10-SCL, PB11-SDA）
- **调试接口**: USART2（PA2-TX, PA3-RX）
- **电机控制**: TIM3四路PWM输出
- **定时器**: TIM4用于PID控制

### 控制系统

**串级PID控制原理**：
```
外环（角度环）→ 内环（角速度环）→ 电机控制
   200Hz          1000Hz
```

**控制频率**：
- 角度环：200Hz（5分频）
- 角速度环：1000Hz（1ms中断）
- 高度环：100Hz（V3.1版本新增）

**电机分配**：
```
       Y+（横滚）
        |
   FL   |   FR
        |
--------+--------> X+（俯仰）
        |
   BL   |   BR
        |
```

- FL: 前左电机（TIM3_CH1）
- FR: 前右电机（TIM3_CH2）
- BR: 后右电机（TIM3_CH3）
- BL: 后左电机（TIM3_CH4）

## 版本对比

| 特性 | V2.5 | V2.9.4.10.24 |
|------|------|--------------|
| 核心功能 | 单纯悬停 | 两次跳跃 |
| PID算法 | 增量式PID | 增量式PID + 死区控制 |
| 飞行逻辑 | 简单悬停 | 多阶段控制 |
| 按键控制 | 无 | 有（第二次起飞） |
| 视觉传感器 | 无 | 预留接口 |
| 适用场景 | 基础悬停测试 | 复杂飞行任务 |

## 开发环境

- **IDE**: STM32CubeIDE
- **配置工具**: STM32CubeMX 6.15.0
- **编译器**: GCC ARM Embedded
- **调试器**: ST-Link/J-Link

## PID参数配置

### 角度环参数（外环）
```c
pid_KGain_roll  = {.Kp = 3.3, .Ki = 0.10, .Kd = 0.02};  // 横滚角
pid_KGain_pitch = {.Kp = 3.3, .Ki = 0.10, .Kd = 0.02};  // 俯仰角
pid_KGain_yaw   = {.Kp = 0.00, .Ki = 0.00, .Kd = 0.00}; // 偏航角
```

### 角速度环参数（内环）
```c
pid_KGain_GyroX = {.Kp = 2.1415926, .Ki = 0.222769, .Kd = 0.0669125}; // X轴
pid_KGain_GyroY = {.Kp = 3.1415926, .Ki = 0.222769, .Kd = 0.0669125}; // Y轴
pid_KGain_GyroZ = {.Kp = 2.5, .Ki = 0.1, .Kd = 0.01};                  // Z轴
```

## 安全机制

- **4秒自动停机**: 防止无人机失控飞走
- **紧急停机**: 安全机制触发后立即关闭所有电机
- **系统锁定**: 停机后进入死循环，需要硬件复位
- **PID死区控制**: 避免小幅抖动，提高稳定性

## 调试和监控

### 串口调试输出
- **格式**: `gyro_x, gyro_y, gyro_z, pitch, roll, yaw`
- **波特率**: 115200
- **工具**: Vofa+、串口助手等

## 使用建议

1. **初次使用**：推荐使用V2.5版本进行基础悬停测试
2. **参数调优**：根据实际飞行效果调整PID参数
3. **安全第一**：所有测试必须在安全环境下进行，必须系好安全绳
4. **传感器要求**：必须使用原装MPU6050芯片，国产替代芯片不支持DMP
5. **逐步升级**：掌握V2.5后再尝试V2.9的复杂飞行逻辑

## 项目结构

```
UAV_F22/
├── 012UAV_RCT6_V2.5/           # V2.5版本 - 单纯悬停
│   └── 012UAV_RCT6_V1.0/
│       ├── Core/               # 核心代码
│       │   ├── Inc/           # 头文件
│       │   │   ├── pid_incremental.h    # 增量式PID
│       │   │   ├── pid_study.h          # 普通PID
│       │   │   ├── pid_incomplete_derivative.h  # 不完全微分PID
│       │   │   ├── pid_integral_separation.h    # 积分分离PID
│       │   │   └── pid_variable_integral.h      # 变速积分PID
│       │   └── Src/           # 源文件
│       ├── Drivers/           # STM32 HAL驱动
│       └── 012UAV_RCT6_V1.0.ioc  # CubeMX配置
├── 012UAV_RCT6_V2.9.4.10.24/  # V2.9版本 - 跳跃功能
│   └── 012UAV_RCT6_V1.0/     # （结构同V2.5）
├── 2.5悬停2025.10.17.mp4      # V2.5悬停演示视频
├── 2.5悬停效果.mp4             # V2.5悬停效果视频
├── 电机顺序.jpg                # 电机接线顺序图
├── 2.5是单纯悬停_2.9是跳2次.txt # 版本说明
└── 基于STM32F103RCT6开发的无人机自主降落系统.mp4 # 项目演示视频
```

## 技术支持

### 参考资料链接
- MPU6050 DMP库移植教程：https://www.bilibili.com/video/BV1KaHvesEza/

### 已知问题
1. 必须使用原装MPU6050芯片，国产替代芯片不支持DMP
2. 传感器零偏需要根据实际硬件进行校准
3. PID参数需要根据实际飞行效果进行调整
4. V2.9版本在第二次启动等待期间可能出现电机似动非动的现象

### 未来改进方向
1. 优化PID参数自适应算法
2. 增加无线遥控功能
3. 实现自主飞行功能
4. 增加故障检测和诊断功能
5. 扩展传感器融合算法（添加气压计、GPS、磁力计）
6. 实现路径规划和避障功能
7. 增加数据记录和分析功能

## 版本历史

### V2.5 (2025.10.17)
- 实现基础悬停功能
- 采用增量式PID控制器
- 1ms定时中断优化
- 4秒安全保护机制

### V2.9.4.10.24 (2025.10.20)
- 实现两次跳跃功能
- 增加按键控制
- 增加PID死区控制
- 预留视觉传感器接口

## 作者信息

- **作者**: XPQH CQX LSL
- **开发日期**: 2025.10.17 - 2025.10.20
- **项目名称**: UAVF22无人机悬停控制系统

## 许可证

本项目遵循MIT许可证。详见LICENSE文件。

## 重要提醒

这是一个涉及高速旋转电机和飞行控制的项目，使用时必须注意安全，确保在受控环境中进行测试，并始终启用安全保护机制。